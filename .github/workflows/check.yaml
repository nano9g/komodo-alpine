name: komodo-release-check
run-name: Check for new Komodo release

on:
  # There's no way to trigger on push to another repo, so we're going to run
  # this job periodically. If there's a new version, the build.env file will
  # be updated and pushed, which will trigger the build workflow.
  # schedule:
  #   - cron: '15 */4 * * *'

  workflow_dispatch:  

jobs:
  # This is the lightweight job that runs and decides whether to perform builds
  release-check:
    name: Komodo version check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for new version
        id: check
        uses: ./.github/actions/komodo-version-check

      - name: Update build.env and trigger workflow
        if: ${{ steps.check.outputs.should_run == 'true' }}
        shell: bash
        run: |
          build_env=".github/workflows/build.env"

          # Set current version
          sed -i "s/BUILD_VERSION=.*/BUILD_VERSION=${{ steps.check.outputs.komodo_tag }}/" "$build_env"

          env_update_prefix="# Updated by komodo-release-check"
          env_update_tagline="${env_update_prefix} $(date)"

          # When we need the build workflow to run, we'll always update the build environment with a timestamp
          # so there's something to commit (allows a single trigger)

          # Replace existing tagline or append to end of file if not found
          # Credit: https://superuser.com/a/976712
          sed -i -e "
            /^${env_update_prefix}/{
              h
              s/.*/${env_update_tagline}/
            }
            \${
              x
              /^$/{
                s//\n${env_update_tagline}/
                H
              }
              x
            }" "$build_env"
          
          git config --global user.name '${{ github.actor }}'
          git config --global user.email '${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com'
          git add .github/workflows/build.env
          git commit -m "Update to ${{ steps.check.outputs.komodo_tag }}"
          git push
